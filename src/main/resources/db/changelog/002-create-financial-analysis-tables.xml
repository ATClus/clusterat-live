<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="002-create-enum-analysis-type" author="clusterat">
        <sql>
            CREATE TYPE enum_analysis_type AS ENUM (
                'good',
                'bad',
                'reducible',
                'superfluous',
                'unnecessary',
                'essential',
                'investment'
            );
        </sql>
    </changeSet>

    <changeSet id="003-create-expense-categories-table" author="clusterat">
        <createTable tableName="expense_categories" remarks="Categorias de despesas e receitas">
            <column name="category_id" type="SERIAL" remarks="Identificador único da categoria">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(100)" remarks="Nome da categoria">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="parent_category_id" type="INT" remarks="Referência para categoria pai (subcategorias)"/>
            <column name="is_income" type="BOOLEAN" defaultValue="false" remarks="Indica se é receita (TRUE) ou despesa (FALSE)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="expense_categories"
                baseColumnNames="parent_category_id"
                referencedTableName="expense_categories"
                referencedColumnNames="category_id"
                constraintName="fk_expense_categories_parent"/>

        <insert tableName="expense_categories">
            <column name="name" value="Salary"/>
            <column name="is_income" value="true"/>
        </insert>
        <insert tableName="expense_categories">
            <column name="name" value="Investments"/>
            <column name="is_income" value="true"/>
        </insert>
        <insert tableName="expense_categories">
            <column name="name" value="Housing"/>
            <column name="is_income" value="false"/>
        </insert>
        <insert tableName="expense_categories">
            <column name="name" value="Food"/>
            <column name="is_income" value="false"/>
        </insert>
        <insert tableName="expense_categories">
            <column name="name" value="Transport"/>
            <column name="is_income" value="false"/>
        </insert>
        <insert tableName="expense_categories">
            <column name="name" value="Leisure"/>
            <column name="is_income" value="false"/>
        </insert>
        <insert tableName="expense_categories">
            <column name="name" value="Superfluous"/>
            <column name="is_income" value="false"/>
        </insert>
    </changeSet>

    <changeSet id="004-create-financial-analysis-table" author="clusterat">
        <createTable tableName="financial_analysis" remarks="Análise financeira de transações">
            <column name="analysis_id" type="BIGSERIAL" remarks="Identificador único da análise">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="source_transaction_id" type="VARCHAR(255)" remarks="ID da transação de origem"/>
            <column name="amount" type="NUMERIC(19,4)" remarks="Valor da transação">
                <constraints nullable="false"/>
            </column>
            <column name="transaction_date" type="TIMESTAMP WITH TIME ZONE" remarks="Data e hora da transação">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="TEXT" remarks="Descrição da transação"/>
            <column name="category_id" type="INT" remarks="Categoria da transação">
                <constraints nullable="false"/>
            </column>
            <column name="analysis_type" type="enum_analysis_type" remarks="Tipo de análise (good, bad, reducible, etc)"/>
            <column name="analysis_notes" type="TEXT" remarks="Notas sobre a análise"/>
            <column name="metadata" type="JSONB" remarks="Dados adicionais em formato JSON"/>
            <column name="created_at" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="NOW()" remarks="Data de criação do registro"/>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="financial_analysis"
                baseColumnNames="category_id"
                referencedTableName="expense_categories"
                referencedColumnNames="category_id"
                constraintName="fk_financial_analysis_category"/>

        <createIndex indexName="idx_financial_analysis_transaction_id" tableName="financial_analysis">
            <column name="source_transaction_id"/>
        </createIndex>

        <createIndex indexName="idx_financial_analysis_category_id" tableName="financial_analysis">
            <column name="category_id"/>
        </createIndex>

        <createIndex indexName="idx_financial_analysis_analysis_type" tableName="financial_analysis">
            <column name="analysis_type"/>
        </createIndex>

        <createIndex indexName="idx_financial_analysis_created_at" tableName="financial_analysis">
            <column name="created_at"/>
        </createIndex>
    </changeSet>

    <changeSet id="005-create-brightdata-received-data-table" author="clusterat">
        <createTable tableName="brightdata_received_data" remarks="Dados recebidos da API Brightdata">
            <column name="id" type="BIGSERIAL" remarks="Identificador único">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="data" type="JSONB" remarks="Dados em formato JSON">
                <constraints nullable="false"/>
            </column>
            <column name="date_received" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="NOW()" remarks="Data e hora de recebimento dos dados">
                <constraints nullable="false"/>
            </column>
            <column name="processed" type="BOOLEAN" defaultValue="false" remarks="Indica se os dados foram processados">
                <constraints nullable="false"/>
            </column>
            <column name="date_processed" type="TIMESTAMP WITH TIME ZONE" remarks="Data e hora do processamento dos dados"/>
        </createTable>

        <createIndex indexName="idx_brightdata_received_data_processed" tableName="brightdata_received_data">
            <column name="processed"/>
        </createIndex>

        <createIndex indexName="idx_brightdata_received_data_date_received" tableName="brightdata_received_data">
            <column name="date_received"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>

